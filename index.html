
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="description" content="Calcite Maps Demo - ArcGIS">
    <link rel="icon" href="http://www.esri.com/favicon.ico">
    <title>VultureVision</title>

    <!-- Calcite Bootstrap -->
    <link rel="stylesheet" href="dist/css/calcite-bootstrap.min-v0.2.css">

    <!-- Calcite Maps -->
    <link rel="stylesheet" href="dist/css/calcite-maps-arcgis-4.x.min-v0.2.css">

    <!-- ArcGIS JS 4.0 -->
    <link rel="stylesheet" href="//js.arcgis.com/4.0/esri/css/main.css">

    <!-- Bootstrap core JavaScript
  ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!-- jQuery (for Bootstrap's JavaScript plugins). NOTE: You can also use pure Dojo. See examples. -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <!-- Include all  plugins or individual files as needed -->
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="dist/js/datepicker/daterangepicker.js"></script>
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
    <script type="text/javascript" src="dist/js/bootstrap_multiselect/bootstrap-multiselect.js"></script>
    <link rel="stylesheet" href="dist/css/bootstrap_multiselect/bootstrap-multiselect.css" type="text/css" />


    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <!--script src="../../assets/js/ie10-viewport-bug-workaround.js"></script-->

    <!-- Calcite Maps -->
    <script src="dist/js/jquery/calcitemaps-v0.2.js"></script>

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            font-weight: 400;
            overflow:hidden;
        }

        .esri-legend {
            background-color: rgba(51,51,51,0.9);
            color: white;
            border: 1px solid #4c4c4c;
            z-index: 3;
        }

        @media screen and (max-width: 768px) {
            .esri-legend {
                display: none;
            }
        }

        .forceLegend {
            display: block !important;
        }

        .esri-ui-top-left {
            z-index: 0;
        }

        #load {
            position: absolute;
            z-index: 5;
            top: 40%;
            left: 50%;
        }

        .dropdown-toggle {
            min-width: auto;
            width: 100% !important;
        }

        .dropdown-menu select {
            left: 0;
        }

        #filter-panel .btn-group {
            display: block;
        }

        #filter-panel .dropdown-toggle {
            margin-left: 0px;
            margin-right: 0px;
            width: 85%!important;
        }

        #filter-panel .btn {
            float: none;
        }

        #filter-panel .form-control {
            width: 85%;
        }

        @media screen and (max-width: 768px) {
            #filter-panel {
                width: 100%!important;
            }
        }

        #nameGrp .btn-group {
            width: 100%;
        }

        .ranges li {
            color: black;
            font-size: 14px;
            font-weight: 400;
        }
    #panelInfoBox {
        position:absolute;
        bottom: 65px;
        right:0px;
        background-color: rgba(51,51,51,0.9);
        z-index: 2;
        /*padding: 10px;*/
        /*font-size:16px;*/
        border-top:1px solid rgb(76,76,76);
        border-left:1px solid rgb(76,76,76);
        /*height: 44px;*/
    }
        #panelInfo, #panelInfoHighlight{
            background-color: rgba(51,51,51,0);
            color:white;
            padding: 10px;
            font-size:16px;
            text-align: center;
        }
        #panelInfoBox:hover{
            border-bottom: 1px solid white;
            cursor: pointer;
        }
        .esri-legend .esri-legend__layer-cell--info:hover{
            font-weight: bold;
            cursor:pointer;
        }
        .highlight {
            font-weight: bold;
            color: rgb(0,251,255);
        }

        .highlightBasemap{
            background-color:#d7d7d7;
        }
        .basemapUL li{
            text-align:center;
        }
       /*.form-control:hover{
           color:white;
           background-color: blue;
       }*/
    </style>

</head>

<body class="calcite-nav-bottom" style="background-color:rgb(51,51,51);">
    <div class="hidden" id="load"><img src="load.gif" class="img-responsive" alt="Loading..." style="height:32px; width:32px;"></div>
    <!-- Navbar -->

    <nav class="navbar calcite-navbar navbar-fixed-bottom calcite-text-light calcite-bg-dark calcite-black-75 dropup" style="background-color:rgba(51,51,51,0.9); border-top:1px solid rgb(76,76,76);">
        <!-- Header -->
        <div class="navbar-header">
            <a class="navbar-brand"><img src="pelican_fly.png" class="img-responsive" alt="Flying pelican"></a>
        </div>
        <!-- Title -->
        <div class="calcite-title calcite-overflow-hidden">
            <div class="calcite-title-main">VultureVision</div>
            <div class="calcite-title-sub">Track a Vulture</div>
        </div>
        <!-- Nav -->
        <ul class="nav navbar-nav">
            <li style="cursor:pointer;"><a id="modalToggle" aria-controls="InfoTab" role="button" data-toggle="modal" data-tooltip="More Info" title="More Info" data-placement="bottom" target = _blank href="http://wildlife.utah.gov/blog/2016/round-trip-flights-salt-lake-city-to-mazatlan/"><span class="glyphicon glyphicon-info-sign"></span><span class="hidden-xs hidden-sm">  Info</span></a><!--data-target="#modalSplash"-->
            </li>
            <a href = "http://wildlife.utah.gov" target= _blank class="navbar-brand"><img src="//wildlife.utah.gov/pelican_webmap/images/DWR_logo_small.png" class="img-fluid" alt="Flying pelican"></a>
        </ul>



    </nav>
    <!--/.FilterDisplayInfo -->
    <div id = "panelInfoBox" class = "panel panel-default">
    <div id="panelInfo" class="panel panel-default"></div>
        </div>
    <!--/.ModalInfo -->
    <div class="modal fade" id="modalSplash" tabindex="-1" role="dialog" aria-labelledby="splashlModal" style="overflow-y: auto;">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true" style="color:white;">&times;</span></button><br>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="splash-body">
                                <div class="text-center">
                                    <h3>What is this project all about?</h3>
                                    <hr>
                                    <p>Pelicans are pretty easy to spot. They are large, weigh 10-20 pounds and have a wingspan of 8-10 feet. They are white with a long neck and a massive, orange bill. You can often see them by the hundreds either swimming, fishing or soaring. They can soar for what seems like forever, on long, broad white and black wings. Seeing one is easy, and usually there isn&#8217;t just one. Catching one, however, is hard.</p>
                                    <div id="attachment_4379" style="width: 385px" class="wp-caption alignleft"><a href="http://wildlife.utah.gov/blog/wp-content/uploads/2016/02/pelicans_blog.png" rel="attachment wp-att-4379"><img class=img-responsive" src="//wildlife.utah.gov/blog/wp-content/uploads/2016/02/pelicans_blog.png" alt="American white pelicans in Utah." width="375" height="211" srcset="//wildlife.utah.gov/blog/wp-content/uploads/2016/02/pelicans_blog.png 777w, //wildlife.utah.gov/blog/wp-content/uploads/2016/02/pelicans_blog-300x169.png 300w, //wildlife.utah.gov/blog/wp-content/uploads/2016/02/pelicans_blog-768x432.png 768w" sizes="(max-width: 375px) 100vw, 375px" /></a>
                                        <p class="wp-caption-text">American white pelicans in Utah.</p>
                                    </div>
                                    <p>I&#8217;ve had the privilege of being involved in the monitoring and management of American White Pelicans in Utah. Pelicans have had some tough times, from disturbance of nesting colonies, pesticide use and population controls.</p>
                                    <p>But through conservation efforts, pelicans have started to make a comeback. They are still not as abundant as they used to be, but the overall outlook is bright. That is a good thing for these birds and for people like me who love to see them.</p>
                                    <p>However, it can also be a not-so-good thing if you are a fish in a sensitive fishery, or an airplane that just had a negative, mid-air interaction with a pelican.</p>
                                    <p>So I — along with a whole team of biologists — am working on answering the questions to better help us continue conserving the pelican and avoid the issues they can cause.</p>
                                    <p>A portion of this kind of work involves banding and tagging young pelicans at the nesting colony on Gunnison Island, <a href="http://wildlife.utah.gov/blog/2015/the-low-speed-stampede/">which you can read in a previous post</a>. Another part of the work (the part that I&#8217;ve been working on) involves catching adult pelicans and attaching GPS transmitters to track daily and seasonal movement patterns.</p>
                                    <div class="form-inline">
                                        <div class="form-group">
                                            <a class="btn btn-success btn-lg" href="http://wildlife.utah.gov/fishing-in-utah/community-fisheries.html" target="_blank">More Information</a>
                                        </div>
                                    </div>
                                    <br>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--/.ModalFilter -->
    <div class="modal fade" id="modalFilter" tabindex="-1" role="dialog" aria-labelledby="modalFilter">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true" style="color:white;">&times;</span></button><br>
                    <div class="text-center">
                        <h2><b>Filter Data</b></h2></div>
                </div>
                <div class="modal-body text-center">

                    <div class="row">
                        <div class="splash-body">
                            <div id="filtercont1">





                                <form class="form" role="form" style="padding-top:20px; display:inline-block !important">
                                    <div style="margin-bottom:5px;"><b>Filter by Name:</b></div>
                                    <div id="nameGrp" class="form-group">

                                        <select id="nameselect" class="form-control input-sm" multiple="multiple">
                                                    <!--<option value="Abigail">Abigail</option>
                                                    <option value="Annabelle">Annabelle</option>
                                                    <option value="Barnabus">Barnabus</option>
                                                    <option value="Bartholomew">Bartholomew</option>
                                                    <option value="Cecilia">Cecilia</option>
                                                    <option value="Chester">Chester</option>
                                                    <option value="Daphne">Daphne</option>
                                                    <option value="Derek">Derek</option>
                                                    <option value="Eleanor">Eleanor</option>
                                                    <option value="Everett">Everett</option>
                                                    <option value="Finnigan">Finnigan</option>
                                                    <option value="Flagg">Flagg</option>
                                                    <option value="George">George</option>
                                                    <option value="Gerald">Gerald</option>
                                                    <option value="Hector">Hector</option>
                                                    <option value="Indie">Indie</option>
                                                    <option value="Jerome">Jerome</option>
                                                    <option value="Kirk">Kirk</option>
                                                    <option value="Loretta">Loretta</option>
                                                    <option value="Manuel">Manuel</option>-->
                                                 </select>
                                    </div>
                                    <!-- form group [rows] -->
                                    <div style="margin-bottom:5px;"><b>Filter by Date:</b></div>
                                    <div class="form-group">

                                        <input type="button" class="form-control input-sm btn-default" id="daterange">
                                    </div>
                                    <!-- form group [search] -->
                                    <div class="form-group">
                                        <button id='applyBtn' type="button" class="btn btn-default filter-col" style="margin-right:10px;margin-left:10px;">
                                        <span class="glyphicon glyphicon-record"></span>    Apply
                                    </button>
                                        <button id='resetBtn' type="button" class="btn btn-default filter-col" style="margin-right:10px;margin-left:10px;">
                                        <span class="glyphicon glyphicon-record"></span>    Reset Filters
                                    </button>
                                    </div>
                                </form>





                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>


    <!-- Map Container  -->

    <div class="calcite-map calcite-map-absolute calcite-overflow-hidden">

        <div id="buttonContainer" style="position:absolute; top:20px; right:10px; z-index: 5;">
            <div class="btn-group ">

                <button id="filterNav2" type="button" class="btn btn-default " data-toggle="modal" data-target="#modalFilter">
                  <span class="esri-icon esri-icon-filter"></span><span class="hidden-xs hidden-sm">   Filter Data</span>
              </button>
            </div>
            <div id="layers" class='btn-group'>
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                  <span class="esri-icon esri-icon-layers"></span><span class="hidden-xs hidden-sm">   Toggle Layers</span>
              </button>
                <ul class="dropdown-menu dropdown-menu-right">
                    <li>
                        <div class="checkbox" style="margin-left:20px;margin-right:20px;">
                            <label><input type="checkbox" id = "hideTrack"> Hide Track Lines
                        </label>
                        </div>
                    </li>
                    <li>
                        <div class="checkbox" style="margin-left:20px;margin-right:20px;">
                            <label><input type="checkbox" id = "togglePts"> Show Data Points
                        </label>
                        </div>
                    </li>
                </ul>
            </div>
            <div class='btn-group'>
                <button id="legendNav" type="button" class="btn btn-default">
                  <span class="glyphicon glyphicon-th-list"></span><span class="hidden-xs hidden-sm">   Toggle Legend</span>
              </button>
            </div>
            <!--<div id="basemap" class='btn-group'>
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                  <span class="esri-icon esri-icon-basemap"></span><span class="hidden-xs hidden-sm">   Change Basemap</span>
              </button>
                <ul class="dropdown-menu dropdown-menu-right">
                    <select id="selectBasemapPanel" class="form-control" style="background-color:white;color:black">
                        <option value="satellite" data-vector="satellite" >Imagery</option>
                        <option value="hybrid" data-vector="hybrid">Imagery with Labels</option>
                        <option value="national-geographic" data-vector="national-geographic">National Geographic</option>
                        <option value="topo" data-vector="topo-vector">Topographic</option>
                        <option value="dark-gray" data-vector="dark-gray-vector" selected="">Dark Gray</option>
                    </select>
                </ul>
            </div>-->
            <div id="basemap" class='btn-group'>
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
                  <span class="esri-icon esri-icon-basemap"></span><span class="hidden-xs hidden-sm">   Change Basemap</span>
              </button>
                <ul class="dropdown-menu dropdown-menu-right basemapUL">
                        <li id="satellite" data-vector="satellite"  ><a href="#">Imagery</a></li>
                        <li id="hybrid" data-vector="hybrid"><a href="#">Imagery with Labels</a></li>
                        <li id="national-geographic" data-vector="national-geographic"><a href="#">National Geographic</a></li>
                        <li id="topo" data-vector="topo-vector"><a href="#">Topographic</a></li>
                        <li id="dark-gray" data-vector="dark-gray-vector" class="highlightBasemap" ><a href="#">Dark Gray</a></li>
                </ul>
            </div>


        </div>
        <div id="tabContainer" class="tab-content">
            <div id="2dTab" class="tab-pane fade in active" role="tabpanel">


                <div id="mapViewDiv">

                </div>
            </div>

        </div>
    </div>
    </div>


    <!-- ArcGIS JS 4.0 -->
    <script src="//js.arcgis.com/4.0/"></script>

    <script>
        var app;
        var startDate = moment().subtract(7, 'days');
        var endDate = moment();
        /*var names_all = ["Abigail", "Annabelle", "Barnabus", "Bartholomew", "Cecilia", "Chester", "Daphne", "Derek", "Eleanor", "Everett", "Finnigan", "Flagg", "George", "Gerald", "Hector", "Indie", "Jerome", "Kirk", "Loretta","Manuel"];*/
        var names_all = [];
        var name_colors = [
            [166, 206, 227],
            [31, 120, 180],
            [178, 223, 138],
            [51, 160, 44],
            [255, 86, 153],
            [227, 26, 28],
            [253, 191, 111],
            [255, 127, 0],
            [202, 178, 214],
            [56, 61, 211],
            [251, 154, 153],
            [177, 89, 40],
            [86, 90, 153],
            [204, 80, 25],
            [117, 255, 0],
            [237, 142, 255],
            [123, 178, 151],
            [255, 236, 191],
            [187, 65, 201],
            [203, 54, 126],
            [102, 202, 234],
            [230, 120, 120],
            [102, 189, 202],
            [95, 95, 215],
            [250, 65, 140],
            [250, 165, 105],
            [175, 205, 120],
            [0, 154, 45],
            [50, 204, 120],
            [67, 80, 255],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0],
            [0, 255, 0]

        ];

        function isInArray(value, array) {
            return array.indexOf(value) > -1;
        }

        var dict = {};


        require(["esri/Map",
            "esri/Basemap",
            "esri/widgets/Home",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/layers/GraphicsLayer",
            "esri/Graphic",
            "esri/tasks/support/Query",
            "esri/widgets/Popup",
            "esri/PopupTemplate",
            "esri/geometry/Polyline", "esri/geometry/Point",
            "esri/symbols/SimpleLineSymbol", "esri/symbols/SimpleMarkerSymbol",
            "esri/widgets/Legend",
                "esri/widgets/Locate",
            "esri/renderers/UniqueValueRenderer",
            "esri/core/watchUtils",
                "esri/geometry/support/webMercatorUtils",
            "dojo/query",
            "dojo/domReady!"
        ], function(Map, Basemap, Home, MapView, FeatureLayer, GraphicsLayer, Graphic, Query, Popup, PopupTemplate, Polyline, Point, SimpleLineSymbol, SimpleMarkerSymbol, Legend, Locate, UniqueValueRenderer, watchUtils,webMercatorUtils, query) {

            // App
            app = {
                scale: 50000000,
                center: [35.5296, -18.6657],
                zoom: 5,
                initialExtent: null,
                basemap: "dark-gray",
                viewPadding: {
                    bottom: 65
                },
                uiPadding: {
                    top: 30,
                    bottom: 15
                },
                mapView: null,
                sceneView: null,
                activeView: null,
                searchWidgetNav: null
            };
            // Map
            var map = new Map({
                basemap: app.basemap
            });

            app.mapView = new MapView({
                container: "mapViewDiv",
                map: map,
                zoom: app.zoom,
                center: app.center,
                padding: app.viewPadding,
                ui: {
                    components: ["zoom"],
                    padding: app.uiPadding
                },
                popup: {
                    dockEnabled: true,
                    dockOptions: {
                        buttonEnabled: true,
                        breakpoint: true,
                        position: 'bottom-center'
                    },
                    visible: false
                },
                constraints: {
                    rotationEnabled: false
                }
            });

            var homeBtn = new Home({
                view: app.mapView
            });
            app.mapView.ui.add(homeBtn, "top-left");

            var rendererPts = new UniqueValueRenderer({
                field: "name"
                    //defaultSymbol: new SimpleFillSymbol()
            });
            var rendererPtsMRP = new UniqueValueRenderer({
                field: "name"
                    //defaultSymbol: new SimpleFillSymbol()
            });
            var rendererLns = new UniqueValueRenderer({
                field: "name"
                    //defaultSymbol: new SimpleFillSymbol()
            });


            app.mapView.popupManager.enabled = false;
            //console.log(app.mapView.popup.ViewModel);
            var gLayer = new GraphicsLayer({
                id: "tracks"
            });
            var gLayerHighlight = new GraphicsLayer({
                id: "tracks"
            });
            var legendLayer = new FeatureLayer({
                url: 'http://services.arcgis.com/ZzrwjTRez6FJiOq4/arcgis/rest/services/TrackedBirds/FeatureServer'

            });
            var gLayerMRP = new GraphicsLayer({
                id: "mrp"
            });
            var gLayerMRPHighlight = new GraphicsLayer({
                id: "mrp"
            });
            var mrp = new FeatureLayer({
                url: 'https://dwrmapserv.utah.gov/arcgis/rest/services/ARGOS/ARGOS_Vulture/MapServer/1',
                outFields: ["*"],
                id: "mrpMain",
                renderer: rendererPtsMRP
            });
            var fl = new FeatureLayer({
                url: "https://dwrmapserv.utah.gov/arcgis/rest/services/ARGOS/ARGOS_Vulture/MapServer/0",
                outFields: ["*"],
                id: 'dataPts',
                renderer: rendererPts

            });


            var locateGL = new GraphicsLayer();
            fl.load();
            var locateWidget = new Locate({
                  view: app.mapView,   // Attaches the Locate button to the view
                  graphicsLayer: locateGL  // The layer the locate graphic is assigned to
                });
             app.mapView.ui.add(locateWidget, "top-left");
            function removeHighlight(){
                    $(".esri-legend__layer-cell.esri-legend__layer-cell--info.highlight").removeClass("highlight");
                    gLayerMRPHighlight.removeAll();
                    map.remove(gLayerMRPHighlight);
                    gLayerHighlight.removeAll();
                    map.remove(gLayerHighlight);
                }



            /*map.add(legendLayer);*/
            map.addMany([legendLayer,mrp,locateGL]);






            // Scene

            // Search
            app.mapView.whenLayerView(mrp).then(function(lyrView) {
                lyrView.watch("updating", function(val) {

                    if (!val) { // wait for the layer view to finish updating

                        // query all the features available for drawing.
                        lyrView.queryFeatures().then(function(results) {


                            //console.log(graphics);

                            $.each(results, function(index, value) {
                                var attributes = value.attributes;
                                var name = attributes.name;
                                console.log(name);
                                names_all.push(name);
                                names_all.sort();
                            });
                            /*$('#nameselect').append("<option value='" + name+ "'>" + name + "</option>");*/

                        });
                        for (var n = 0; n < names_all.length; n++) {
                            dict[names_all[n]] = name_colors[n];
                            $('#nameselect').append($('<option/>', {
                                    value: names_all[n],
                                    text: names_all[n]
                                }));
                        }
                        console.log(dict);
                        for (i in dict) {
                            rendererPts.addUniqueValueInfo(i,
                                new SimpleMarkerSymbol({
                                    color: dict[i],
                                    size: '6px'
                                })
                            );
                            rendererPtsMRP.addUniqueValueInfo(i,
                                new SimpleMarkerSymbol({
                                    color: dict[i],
                                    size: '14px'
                                })
                            );
                            rendererLns.addUniqueValueInfo(i,
                                new SimpleLineSymbol({
                                    color: dict[i],
                                    width: 1
                                })
                            );
                        }
                        $('#nameselect').multiselect({
                            includeSelectAllOption: true
                        });
                        $("#nameselect").multiselect('selectAll', false);
                        $("#nameselect").multiselect('updateButtonText');
                        legendLayer.renderer = rendererPtsMRP;
                        mrp.renderer = rendererPtsMRP;

                        var start = startDate.format('MM-DD-YYYY');
                        var end = endDate.add(23,'hours').format('MM-DD-YYYY');
                        var dQuery = "Date_time <= date'" + end + "' AND Date_time >= date'" + start + "'";
                        //dQuery = "Date_time <= date'06-16-2016' AND Date_time >= date'05-01-2016'";
                        console.log(dQuery);
                        fl.definitionExpression = dQuery;
                        fl.queryExtent().then(function(results) {
                            // go to the extent of the results satisfying the query
                            console.log(results.extent);
                            app.mapView.goTo(results.extent.expand(1.25));/* default load*/
                            console.log("went to extent");
                        });
                        fl.queryFeatures().then(function(results) {
                            // prints the array of result graphics to the console
                            //console.log(results.extent);
                            var ptt_list = [];
                            var geom = results.features;
                            geom.forEach(function(i) {
                                var x = i.attributes.name;
                                if (!isInArray(x, ptt_list)) {
                                    ptt_list.push(x);
                                }
                            });

                            var ptList = [];
                            for (var i = 0; i < ptt_list.length; i++) {
                                var latLngArray = [];

                                var ptList2 = [];
                                geom.forEach(function(arrayItem) {
                                    if (arrayItem.attributes.name == ptt_list[i]) {
                                        ptList2.push(arrayItem);
                                        var coords = [];
                                        coords.push(arrayItem.geometry.longitude);
                                        coords.push(arrayItem.geometry.latitude);
                                        latLngArray.push(coords);

                                    }

                                });
                                ptList2.sort(function(a, b) {
                                    return parseFloat(a.attributes.Date_time) - parseFloat(b.attributes.Date_time);
                                });
                                ptList.push(ptList2);
                            }




                            console.log("ListL", ptList.length);
                            for (var x = 0; x < ptList.length; x++) {
                                var coordinates = [];
                                var name = ptList[x][0].attributes.name;
                                for (var y = 0; y < ptList[x].length; y++) {
                                    var coordTemp = [];
                                    coordTemp.push(ptList[x][y].geometry.longitude);
                                    coordTemp.push(ptList[x][y].geometry.latitude);
                                    coordinates.push(coordTemp);
                                }
                                var endIndex = ptList[x].length - 1;
                                var date1 = ptList[x][endIndex].attributes.Date_time;
                                var ptAtt = {
                                    name: name,
                                    Date_time: date1
                                };
                                var mrpPt = new Point({
                                    latitude: ptList[x][endIndex].geometry.latitude,
                                    longitude: ptList[x][endIndex].geometry.longitude,
                                });
                                var mrpGraphic = new Graphic({
                                    geometry: mrpPt,
                                    symbol: new SimpleMarkerSymbol({
                                        color: dict[name],
                                        size: '13px'
                                    }),
                                    attributes: ptAtt
                                });

                                gLayerMRP.add(mrpGraphic);

                                var pl = new Polyline({
                                    paths: coordinates
                                });
                                var lineAtt = {
                                    name: name
                                };
                                var lineSymbol = new SimpleLineSymbol({
                                    color: dict[name],
                                    width: "1.5px"
                                });
                                var plGraphic = new Graphic({
                                    geometry: pl,
                                    symbol: lineSymbol,
                                    attributes: lineAtt
                                });
                                gLayer.add(plGraphic);
                            }
                            //console.log(latLngArray);



                            //$('#load').toggleClass('hidden show');
                        });
                        map.remove(mrp);
                        gLayer.popupEnabled = false;
                        //app.mapView.popupManager.enabled = false;
                        map.add(gLayer);
                        map.add(gLayerMRP);
                         var legend = new Legend({
                            view: app.mapView,
                            layerInfos: [{
                                layer: legendLayer,
                                title: "Tracked Pelicans"
                            }]
                        });

                        legend.startup();
                        app.mapView.ui.add(legend, "bottom-left");
                        console.log(gLayer);
                        console.log(app.mapView);

                    }
                });
            });




            // Panel Events
            query(".calcite-panels .panel").on("show.bs.collapse", function(e) {
                if (app.activeView.popup.currentDockPosition) {
                    app.activeView.popup.dockEnabled = false;
                }
            });
            // Window Events

            // Panel show/hide


            // Tab Events (Views)
            /*query(".calcite-navbar li a[data-toggle='tab']").on("click", function(e) {
                syncTabs(e);
                if (e.target.text.indexOf("Map") > -1) {
                    syncViews(app.sceneView, app.mapView);
                    app.activeView = app.mapView;
                } else {
                    syncViews(app.mapView, app.sceneView);
                    app.activeView = app.sceneView;
                }
                syncSearch();
            });*/
            // Tab

            // Basemap events
            /*query("#selectBasemapPanel").on("change", function(e) {
                app.mapView.map.basemap = e.target.value;
                //$('#basemap').removeClass('open');
                $('.dropdown.open .dropdown-toggle').dropdown('toggle');
            });*/

            $('ul.basemapUL li').click(function() {
                app.mapView.map.basemap = this.id;
                $(this).addClass('highlightBasemap');
                $(this).siblings().removeClass('highlightBasemap');
                /*console.log(this.id);
                console.log($(this).attr('data-vector'));*/
            });
            $(".dropdown-menu a").click(function() {
                $(this).closest(".dropdown-menu").prev().dropdown("toggle");
            });

            // Collapsible popup (optional)
            query(".esri-popup .esri-title").on("click", function(e) {
                query(".esri-popup .esri-container").toggleClass("esri-popup-collapsed");
                app.activeView.popup.reposition();
            });
            // Home

            $('#hideTrack').click(function() {
                if ($(this).is(':checked')) {
                    map.remove(gLayer);

                } else {
                    map.add(gLayer);
                }
            });


            $('#togglePts').click(function() {
                if ($(this).is(':checked') && typeof startDate !== "undefined") {
                    map.add(fl);
                    map.add(gLayerMRP);

                } else if ($(this).is(':checked') && typeof startDate == "undefined") {
                    $('#togglePts').attr('checked', false);
                } else {
                    map.remove(fl);
                }
            });





            $('#resetBtn').click(function(event) {
                //legendLayer.renderer = rendererPtsMRP;
                event.preventDefault();
                $( "#panelInfo" ).text("Most recent point for each pelican");
                $('#modalFilter').modal('hide');
                $('#daterange').val('Most Recent Points Shown');
                $('#nameselect').multiselect("selectAll", false);
                $('#nameselect').multiselect('refresh');
                $('#togglePts').attr('checked', false);
                removeHighlight();
                var rendererVis = new UniqueValueRenderer({
                    field: "name"
                        //defaultSymbol: new SimpleFillSymbol()
                });
                var selected = $('#nameselect option:selected').map(function(a, item) {
                    return item.value;
                });
                for (var i = 0; i < selected.length; i++) {
                    rendererVis.addUniqueValueInfo(selected[i],
                        new SimpleMarkerSymbol({
                            color: dict[selected[i]],
                            size: '12px'
                        })
                    );
                }
                legendLayer.renderer = rendererVis;
                map.remove(fl);
                map.add(mrp);
                gLayer.removeAll();
                gLayerMRP.removeAll();

            });

            $('.panel-close').click(function(event) {
                event.preventDefault();
                $('#panelBasemaps').toggleClass('hidden show');
                $('#basemapNav2').toggleClass('active');

            });

            $('#filterNav2').click(function(event) {
                event.preventDefault();
                $('#filtercont').toggleClass('hidden show');


            });
            $('li#basemapNav2').click(function(event) {
                event.preventDefault();
                $('#panelBasemaps').toggleClass('hidden show');
                $('#basemapNav2').toggleClass('active');
            });
            $('#legendNav').click(function(event) {
                event.preventDefault();
                $('.esri-legend').toggleClass('hidden show');
                //console.log(screen.width);
                if ((screen.width < 768)) {
                    console.log("screen small");
                    // if screen size is 1025px wide or larger
                    $('.esri-legend').toggleClass('forceLegend');
                }

                $('#legendNav').toggleClass('active');
            });
            $('#panelInfoBox').click(function(event) {
                $("#filterNav2").click();
            });
            $(document).ready(function() {

                $('#daterange').keypress(function(e) {
                    if (e.which == 13) { // Checks for the enter key
                        e.preventDefault();
                        $("#applyBtn").click();
                    }
                });


                function cb(start, end) {
                    $('#daterange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
                }
                cb(moment().subtract(3, 'days'), moment());

                $('#daterange').daterangepicker({
                        autoApply: true,
                        startDate: moment().subtract(7, 'days'),
                        endDate: moment(),
                        minDate: "08/10/2015",
                        maxDate: moment(),
                        parentEl: $("#filtercont"),
                        ranges: {
                            'Last 7 Days': [moment().subtract(7, 'days'), moment()],
                            'Last 14 Days': [moment().subtract(14, 'days'), moment()],
                            'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                            'Last 90 Days': [moment().subtract(3, 'months'), moment()],
                            'Last Year': [moment().subtract(1, 'year'), moment()],
                            'Show All Data': ["08/10/2015", moment()]
                        },
                        drops: 'down',
                        opens: "center"
                    },
                    function(start, end, label) {
                        console.log('New date range selected: ' + start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD') + ' (predefined range: ' + label);
                        startDate = start;
                        endDate = end;
                    }
                );

                $( "#panelInfo" ).text(startDate.format('MM-DD-YYYY') + ' to ' + endDate.format('MM-DD-YYYY'));

                $(document).on('click', '#layers .dropdown-menu', function(e) {
                    e.stopPropagation();
                });
                $(document).on('click', '.esri-legend .esri-legend__layer-cell--info', function(e) {
                    var txt = $(e.target).text();
                    var target = e.target;
                    /*if (isInArray(txt,names_all)){*/
                    if (isInArray(txt,names_all)){
                        removeHighlight();
                        $(target).addClass('highlight');

                        for (var i = 0; i < (gLayerMRP.graphics.items).length; i++) {
                            if (gLayerMRP.graphics.items[i].attributes.name == txt && gLayer.graphics.items[i].attributes.name == txt){
                                var cloneGraphic = gLayerMRP.graphics.items[i].clone();
                                cloneGraphic.symbol.outline.color.g = 251;
                                cloneGraphic.symbol.outline.color.b = 255;
                                cloneGraphic.symbol.outline.width = 2;
                                gLayerMRPHighlight.add(cloneGraphic);
                                var cloneTrack = gLayer.graphics.items[i].clone();
                                cloneTrack.symbol.color.g = 251;
                                cloneTrack.symbol.color.b = 255;
                                cloneTrack.symbol.color.r = 0;
                                cloneTrack.symbol.width = 2;
                                gLayerHighlight.add(cloneTrack);
                            }
                        }
                        map.add(gLayerHighlight);
                        map.add(gLayerMRPHighlight);
                    }
                });

                $('#daterange').on('apply.daterangepicker', function(ev, picker) {
                    $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
                });

                $('#daterange').on('cancel.daterangepicker', function(ev, picker) {
                    $(this).val('');
                });


                $('#applyBtn').click(function(event) {
                    $('#modalFilter').modal('hide');
                    $('#load').toggleClass('hidden show');
                    $('#filtercont').toggleClass('hidden show');
                    event.preventDefault();
                    $( "#panelInfo" ).text(startDate.format('MM-DD-YYYY') + ' to ' + endDate.format('MM-DD-YYYY'));
                    app.mapView.popup.close();
                    //app.mapView.goTo(homeBtn.viewpoint);
                    removeHighlight();
                    gLayer.removeAll();
                    gLayerMRP.removeAll();
                    map.remove(mrp);

                    var selected = $('#nameselect option:selected').map(function(a, item) {
                        return item.value;
                    });
                    if (selected.length > 0) {
                        //
                        var rendererVis = new UniqueValueRenderer({
                            field: "name"
                                //defaultSymbol: new SimpleFillSymbol()
                        });
                        legendLayer.renderer = rendererVis;

                        //
                        var nameListStr = "name IN (";
                        for (var i = 0; i < selected.length; i++) {
                            rendererVis.addUniqueValueInfo(selected[i],
                                new SimpleMarkerSymbol({
                                    color: dict[selected[i]],
                                    size: '12px'
                                })
                            );
                            if (i < selected.length - 1) {
                                nameListStr = nameListStr + "'" + selected[i] + "',";
                            } else {
                                nameListStr = nameListStr + "'" + selected[i] + "')";
                            }
                        }
                    } else {
                        nameListStr = "";
                    }

                    var dQuery;

                    if (startDate == null) {
                        dQuery = "";
                    } else {
                        var sDate = startDate.format('MM-DD-YYYY');
                        var eDate = endDate.add(23,'hours').format('MM-DD-YYYY');
                        dQuery = "Date_time <= date'" + eDate + "' AND Date_time >= date'" + sDate + "'";

                    }

                    var query;
                    if (nameListStr == "" && dQuery.length > 2) {
                        query = dQuery;
                    } else if (nameListStr == "" && dQuery == "") {
                        query = "name IN ()";
                        $('#load').toggleClass('hidden show');
                    } else if (nameListStr.length > 2 && dQuery.length == 0) {
                        query = nameListStr;
                    } else {
                        query = dQuery + " AND " + nameListStr;
                    }
                    //console.log(nameListStr);
                    //var query = "ptt_id IN "+nameListStr;

                    console.log(query);
                    //dQuery = "Date_time <= date'06-16-2016' AND Date_time >= date'05-01-2016'";
                    //console.log(dQuery);
                    fl.definitionExpression = query;
                    fl.queryExtent().then(function(results) {
                        // go to the extent of the results satisfying the query
                        console.log(results.extent);
                        app.mapView.goTo(results.extent.expand(1.75));
                        console.log("went to extent");
                    });
                    fl.queryFeatures().then(function(results) {
                        // prints the array of result graphics to the console
                        //console.log(results.extent);
                        var ptt_list = [];
                        var geom = results.features;
                        geom.forEach(function(i) {
                            var x = i.attributes.name;
                            if (!isInArray(x, ptt_list)) {
                                ptt_list.push(x);
                            }
                        });

                        var ptList = [];
                        for (var i = 0; i < ptt_list.length; i++) {
                            var latLngArray = [];

                            var ptList2 = [];
                            geom.forEach(function(arrayItem) {
                                if (arrayItem.attributes.name == ptt_list[i]) {
                                    ptList2.push(arrayItem);
                                    var coords = [];
                                    coords.push(arrayItem.geometry.longitude);
                                    coords.push(arrayItem.geometry.latitude);
                                    latLngArray.push(coords);

                                }

                            });
                            ptList2.sort(function(a, b) {
                                return parseFloat(a.attributes.Date_time) - parseFloat(b.attributes.Date_time);
                            });
                            ptList.push(ptList2);
                        }




                        console.log("ListL", ptList.length);
                        for (var x = 0; x < ptList.length; x++) {
                            var coordinates = [];
                            var name = ptList[x][0].attributes.name;
                            for (var y = 0; y < ptList[x].length; y++) {
                                var coordTemp = [];
                                coordTemp.push(ptList[x][y].geometry.longitude);
                                coordTemp.push(ptList[x][y].geometry.latitude);
                                coordinates.push(coordTemp);
                            }
                            var endIndex = ptList[x].length - 1;
                            var date1 = ptList[x][endIndex].attributes.Date_time;
                            var ptAtt = {
                                name: name,
                                Date_time: date1
                            };
                            var mrpPt = new Point({
                                latitude: ptList[x][endIndex].geometry.latitude,
                                longitude: ptList[x][endIndex].geometry.longitude,
                            });
                            var mrpGraphic = new Graphic({
                                geometry: mrpPt,
                                symbol: new SimpleMarkerSymbol({
                                    color: dict[name],
                                    size: '13px'
                                }),
                                attributes: ptAtt
                            });

                            gLayerMRP.add(mrpGraphic);

                            var pl = new Polyline({
                                paths: coordinates
                            });
                            var lineAtt = {
                                name: name
                            };
                            var lineSymbol = new SimpleLineSymbol({
                                color: dict[name],
                                width: "1.5px"
                            });
                            var plGraphic = new Graphic({
                                geometry: pl,
                                symbol: lineSymbol,
                                attributes: lineAtt
                            });
                            gLayer.add(plGraphic);
                        }
                        //console.log(latLngArray);



                        $('#load').toggleClass('hidden show');
                    });
                    //map.add(fl);
                    gLayer.popupEnabled = false;

                    //app.mapView.popupManager.enabled = false;
                    if (!$('#hideTrack').is(':checked')) {
                        map.add(gLayer);
                    }
                    map.add(gLayerMRP);
                    console.log(gLayer);
                    console.log(app.mapView);
                });



            });
            app.mapView.watch("updating", function(val) {
                if (val == 'loaded') {
                    //hide gif
                    $('#load').toggleClass('hidden show');


                } else {
                    //show gif
                    $('#load').toggleClass('hidden show');
                    console.log("mapview",app.mapView);

                }
            }); // wait for the layer view to finish updating


            app.mapView.on("click", function(event) {
  app.mapView.hitTest(event.screenPoint).then(function(response) {
            if(response.results.length > 0 && response.results[0].graphic && response.results[0].graphic.layer.id == 'mrp'){
          var center = webMercatorUtils.geographicToWebMercator(new Point({
                                latitude: response.results[0].graphic.geometry.latitude,
                                longitude: response.results[0].graphic.geometry.longitude,
                            }));
          var datePop = moment.unix((response.results[0].graphic.attributes.Date_time)/1000);
          var name = response.results[0].graphic.attributes.name;
          datePop = datePop.format("dddd, MMMM Do YYYY, h:mm:ss a");
          app.mapView.popup.open({
                title: name,
              content: "Seen here on "+ datePop,
                location: center
              });
    }
          else if(response.results.length == 1 && response.results[0].graphic && response.results[0].graphic.layer.id == 'dataPts'){
            var center = webMercatorUtils.geographicToWebMercator(new Point({
                                latitude: response.results[0].graphic.geometry.latitude,
                                longitude: response.results[0].graphic.geometry.longitude,
                            }));
          var datePop = moment.unix((response.results[0].graphic.attributes.Date_time)/1000);
              var name = response.results[0].graphic.attributes.name;
              datePop = datePop.format("dddd, MMMM Do YYYY, h:mm:ss a");
              app.mapView.popup.open({
                    title: name,
                  content: "Seen here on "+ datePop,
                    location: center
                  });
      }
              else if(response.results.length == 1 && response.results[0].graphic && response.results[0].graphic.layer.id == 'mrpMain'){
            var center = webMercatorUtils.geographicToWebMercator(new Point({
                                latitude: response.results[0].graphic.geometry.latitude,
                                longitude: response.results[0].graphic.geometry.longitude,
                            }));
          var datePop = moment.unix((response.results[0].graphic.attributes.Date_time)/1000);
              var name = response.results[0].graphic.attributes.name;
              datePop = datePop.format("dddd, MMMM Do YYYY, h:mm:ss a");
              app.mapView.popup.open({
                    title: name,
                  content: "Seen here on "+ datePop,
                    location: center
                  });
      }
              else if(response.results.length == 1 && response.results[0].graphic && response.results[0].graphic.layer.id == 'colonies'){
            var center = webMercatorUtils.geographicToWebMercator(new Point({
                                latitude: response.results[0].graphic.geometry.latitude,
                                longitude: response.results[0].graphic.geometry.longitude,
                            }));
          var name = response.results[0].graphic.attributes.COLONY + " Colony";
              var population = response.results[0].graphic.attributes.Pop;
              app.mapView.popup.open({
                    title: name,
                  content: "Estimated Population of "+ population.toString(),
                    location: center
                  });
      }
              else if(response.results.length == 1  && response.results[0].graphic && response.results[0].graphic.layer.id == 'resightUT'){
            var center = webMercatorUtils.geographicToWebMercator(new Point({
                                latitude: response.results[0].graphic.geometry.latitude,
                                longitude: response.results[0].graphic.geometry.longitude,
                            }));
          var band = response.results[0].graphic.attributes.Band_No_;
          var bandDate = moment.unix((response.results[0].graphic.attributes.Band_Date)/1000).format('MMMM Do YYYY');
              var returnDate =moment.unix((response.results[0].graphic.attributes.Return_Date)/1000).format('MMMM Do YYYY');
          var bandingLocation = response.results[0].graphic.attributes.Banding_Location;
          var bandStatus = response.results[0].graphic.attributes.Status;
              app.mapView.popup.open({
                    title: "Resighting Location",
                  content: "<b>Band Number:</b> "+band+"<br><b>Banding Date:</b> "+bandDate+"<br><b>Return Date:</b> "+ returnDate+"<br><b>Natal Colony:</b> "+ bandingLocation+"<br><b>Status:</b> "+ bandStatus+"<br>",
                    location: center
                  });
      }
              else if(response.results.length == 1 && response.results[0].graphic && response.results[0].graphic.layer.id == 'resightID'){
            var center = webMercatorUtils.geographicToWebMercator(new Point({
                                latitude: response.results[0].graphic.geometry.latitude,
                                longitude: response.results[0].graphic.geometry.longitude,
                            }));
          var band = response.results[0].graphic.attributes.Band_Numbe;
          var resightDate = moment.unix((response.results[0].graphic.attributes.Date)/1000).format('MMMM Do YYYY');
          var bandYear = response.results[0].graphic.attributes.Banding_Ye;
          var natalColony = response.results[0].graphic.attributes.Natal_Colo;
          var bandStatus = response.results[0].graphic.attributes.Status;
              app.mapView.popup.open({
                    title: "Resighting Location",
                  content: "<b>Band Number: </b>"+ band+ "<br><b>Date:</b>"+resightDate +"<br><b>Banding Year:</b>"+ bandYear+"<br><b>Natal Colony:</b>"+ natalColony+ "<br><b>Status:</b>"+ bandStatus+"<br>",
                    location: center
                  });
      }
              else if(response.results.length > 1){
                console.log("Firing loop");
                for (var x = 0; x < response.results.length; x++) {
                    if (response.results[x].graphic.layer.id == 'mrp' || response.results[x].graphic.layer.id == 'dataPts'){
                var center = webMercatorUtils.geographicToWebMercator(new Point({
                                latitude: response.results[x].graphic.geometry.latitude,
                                longitude: response.results[x].graphic.geometry.longitude,
                            }));
              var datePop = moment.unix((response.results[x].graphic.attributes.Date_time)/1000);
              var name = response.results[x].graphic.attributes.name;
              datePop = datePop.format("dddd, MMMM Do YYYY, h:mm:ss a");
              app.mapView.popup.open({
                    title: name,
                  content: "Seen here on "+ datePop,
                    location: center
                  });
      }}}
      else{console.log("Clicked Track Line");
          app.mapView.popup.close();
          removeHighlight();
      }
  });
});

        });
    </script>



</body>

</html>